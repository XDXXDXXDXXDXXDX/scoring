<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>脚本大小 | 快应用性能优化实践</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="通过学习文档中快应用的优化方法，让您快速提升您得快应用性能">
    
    <link rel="preload" href="/scoring/assets/css/0.styles.b2f7e813.css" as="style"><link rel="preload" href="/scoring/assets/js/app.52a312f5.js" as="script"><link rel="preload" href="/scoring/assets/js/2.7d8236c8.js" as="script"><link rel="preload" href="/scoring/assets/js/4.fa51cec4.js" as="script"><link rel="prefetch" href="/scoring/assets/js/10.f96a9636.js"><link rel="prefetch" href="/scoring/assets/js/11.ae94b523.js"><link rel="prefetch" href="/scoring/assets/js/12.e2d2e0a4.js"><link rel="prefetch" href="/scoring/assets/js/13.b12bd717.js"><link rel="prefetch" href="/scoring/assets/js/14.86937e2f.js"><link rel="prefetch" href="/scoring/assets/js/3.5cb55f3c.js"><link rel="prefetch" href="/scoring/assets/js/5.f137d1c3.js"><link rel="prefetch" href="/scoring/assets/js/6.082cacbb.js"><link rel="prefetch" href="/scoring/assets/js/7.15e63327.js"><link rel="prefetch" href="/scoring/assets/js/8.5854f87d.js"><link rel="prefetch" href="/scoring/assets/js/9.4985d3f8.js">
    <link rel="stylesheet" href="/scoring/assets/css/0.styles.b2f7e813.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/scoring/" class="home-link router-link-active"><!----> <span class="site-name">快应用性能优化实践</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开始</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>rpk包大小优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scoring/guide/rpk-subpackage.html" class="sidebar-link">分包加载</a></li><li><a href="/scoring/guide/rpk-compress-image.html" class="sidebar-link">图片大小</a></li><li><a href="/scoring/guide/rpk-compress-js.html" aria-current="page" class="active sidebar-link">脚本大小</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/scoring/guide/rpk-compress-js.html#分析包大小" class="sidebar-link">分析包大小</a></li><li class="sidebar-sub-header"><a href="/scoring/guide/rpk-compress-js.html#第三方库" class="sidebar-link">第三方库</a></li><li class="sidebar-sub-header"><a href="/scoring/guide/rpk-compress-js.html#工具脚本" class="sidebar-link">工具脚本</a></li><li class="sidebar-sub-header"><a href="/scoring/guide/rpk-compress-js.html#结构优化" class="sidebar-link">结构优化</a></li><li class="sidebar-sub-header"><a href="/scoring/guide/rpk-compress-js.html#独立打包javascript" class="sidebar-link">独立打包javascript</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运行时优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="脚本大小"><a href="#脚本大小" class="header-anchor">#</a> 脚本大小</h1> <p>当引用了第三包的脚本或者没有按需引用公共的工具方法时，会导致不同页面含有相同的js脚本，导致整体包体积过大。</p> <p>本文档借助webpack-bundle-analyzer完成对js文件的优化。</p> <h2 id="分析包大小"><a href="#分析包大小" class="header-anchor">#</a> 分析包大小</h2> <p>首先在项目中安装webpack-bundle-analyzer</p> <div class="language- extra-class"><pre class="language-text"><code>npm install --save-dev webpack-bundle-analyzer
</code></pre></div><p>在项目的根目录新建构建配置文件 quickapp.config.js 并添加以下内容</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行hap build 即会在弹出的浏览器中展现可视化的包大小分析结果，单文件越大，那么他的方块也就越大</p> <p><img src="/scoring/assets/img/webpack-build.740f4c98.png" alt="build"></p> <p>点击左边的菜单，将Treemap sizes切换到Stat，即可看到详细的文件大小占用情况</p> <p><img src="/scoring/assets/img/lodash.dbf222b6.png" alt="build"></p> <p>现实的开发场景下一般也只有两种脚本，一种是第三方的工具库，一种是开发者自己封装的函数，下面都给出对应的优化方式。</p> <p>示例中，是在不同的页面都有引入了完整的lodash库导致了整体包体积过大。</p> <h2 id="第三方库"><a href="#第三方库" class="header-anchor">#</a> 第三方库</h2> <p>我们建议使用第三方库时，用按需引入的方式替代完整引入，如示例中我们打开 main-page 导入的 common.js 文件，将其引入loadsh方式做更改</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// var _ = require('lodash'); 不推荐的完整引入方式</span>

<span class="token keyword">var</span> _concat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash/concat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>重新构建可以看到，相比于没有做此改动的app.ux文件，common.js直接小了400KB+！main-page中lodsh的占比已经小的微不足道了。</p> <p><img src="/scoring/assets/img/lodash-optimize.47bc266f.png" alt="build"></p> <p>如果项目中已经过多的引入导致修改比较繁杂，也可以借助 lodash-webpack-plugin，babel-plugin-lodash插件进行优化，推荐阅读其<a href="https://www.npmjs.com/package/lodash-webpack-plugin" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="工具脚本"><a href="#工具脚本" class="header-anchor">#</a> 工具脚本</h2> <p>项目中常常会维护一份utils.js，该文件会保存一些常用的工具的函数如</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">util1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'util 1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">util2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'util 2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">util3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'util 3'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是在使用时我们往往只需要其中的一个或两个函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// main-page/index.ux</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> util1<span class="token punctuation">,</span> util2 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../helper/utils.js'</span>
</code></pre></div><p>但是在构建之后是会将utils.js完整引入到页面中的，包括那些你用不到的函数。在项目越来越复杂之后，每个方法也会越来越大导致最后utils臃肿不堪。</p> <p>所以我们建议将工具方法拆分，尽量一个方法一个文件，引入方法时仅引入对应的一个文件即可</p> <p><img src="data:image/png;base64,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" alt="utils"></p> <h2 id="结构优化"><a href="#结构优化" class="header-anchor">#</a> 结构优化</h2> <p>结构优化的目的是减小页面以及整体 rpk 包的体积，减少冗余代码。</p> <p>对于一些常用的方法，不论是第三方的还是开发者自己编写的，我们建议将其暴露到全局中。</p> <p>在使用分包的情况下，该优化方案需要注意不要将所有可能用到的、甚至可能只有一两个页面用到的方法都放到全局中，这将会导致首包过大反而减慢了加载速度。</p> <p>我们提供了两种注入方式，让您在应用的任何地方都能调用到注入的方法</p> <h3 id="注入到全局中"><a href="#注入到全局中" class="header-anchor">#</a> 注入到全局中</h3> <p><a href="https://doc.quickapp.cn/tutorial/framework/optimization-skills.html?h=%E4%BC%98%E5%8C%96#%E4%BD%BF%E7%94%A8-globaljs" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>假设开发者已经按照上面的方法将脚本拆分完毕，可以参考示例demo中 /src/helper/utils 文件夹</p> <p><img src="data:image/png;base64,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" alt="utils break"></p> <p>在utils文件夹下创建index.js，加入以下脚本将所有方法统一导出</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> files <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

files<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'./index.js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>utils<span class="token punctuation">,</span> <span class="token function">files</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> utils
</code></pre></div><p>新建 global.js文件，添加如下脚本将utils.js导出的对象注入到global的$utils中</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'./helper/utils/index.js'</span>

<span class="token keyword">const</span> hook2global <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span> <span class="token operator">||</span> global

hook2global<span class="token punctuation">.</span>$utils <span class="token operator">=</span> utils <span class="token comment">// 注入到全局中</span>
</code></pre></div><p>最后在app.ux中引入 global.js 即可</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token string">'./global.js'</span>
</code></pre></div><p>在任意页面即可直接调用注入的 $utils 对象上的方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// other.ux</span>
$utils<span class="token punctuation">.</span><span class="token function">getByteLength</span><span class="token punctuation">(</span><span class="token string">'quickapp!'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="注入到app中"><a href="#注入到app中" class="header-anchor">#</a> 注入到App中</h3> <p><a href="https://doc.quickapp.cn/tutorial/framework/lifecycle.html#%E5%85%B3%E4%BA%8Eapp-%E4%B8%8Eappdef" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>快应用中提供$app.$def对象，$app.$def代表开发者在 app.ux 中导出的对象（即export default导出的内容），可以放置业务相关的全局数据和方法；</p> <p>参考示例，在app.ux中添加如下代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'./helper/utils/index.js'</span> <span class="token comment">// 导入utils对象</span>

<span class="token comment">// 将utils对象中的部分属性导出供其他页面使用</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  showMenu<span class="token operator">:</span> utils<span class="token punctuation">.</span>showMenu<span class="token punctuation">,</span>
  createShortcut<span class="token operator">:</span> utils<span class="token punctuation">.</span>createShortcut
<span class="token punctuation">}</span>
</code></pre></div><p>在其他页面中，通过this.$app.$def.[method Name]调用即可，如</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// other.ux</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">onInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$app<span class="token punctuation">.</span>$def<span class="token punctuation">.</span><span class="token function">createShortcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="独立打包javascript"><a href="#独立打包javascript" class="header-anchor">#</a> 独立打包javascript</h2> <p>针对上面重复引入的问题，快应用平台自1080版本起支持 JS 资源独立打包，当 app.ux 或页面文件两次或以上引用到同一 JS 资源时，会将该 JS 资源抽取到独立的文件中，使得相关文件共用同一份 JS 代码。详细说明可以查看<a href="https://doc.quickapp.cn/framework/js-split.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/scoring/guide/rpk-compress-image.html" class="prev">
        图片大小
      </a></span> <span class="next"><a href="/scoring/guide/runtime-js.html">
        脚本执行时间
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/scoring/assets/js/app.52a312f5.js" defer></script><script src="/scoring/assets/js/2.7d8236c8.js" defer></script><script src="/scoring/assets/js/4.fa51cec4.js" defer></script>
  </body>
</html>
